"use strict";!function(){function e(){return new Promise(function(e,t){"interactive"==document.readyState||"complete"==document.readyState?e():document.addEventListener("DOMContentLoaded",e,!1)})}function t(){return"refuri="+window.location.hostname}function n(e,t,n,r,o){return new Promise(function(a,c){var i=new XMLHttpRequest;i.open(e,t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o&&o.forEach(function(e){i.setRequestHeader(e.hdr,e.value)}),r&&(i.responseType=r),i.addEventListener("readystatechange",function(){4==i.readyState&&a(i)},!1),i.send(n)})}function r(e,t){for(var n in e)e.hasOwnProperty(n)&&t(e[n],n)}function o(e,t,n,o,a,c){var i=!1;if(r(f,function(e,n){n==t&&(a&&e.push(a),i=!0)}),i)return!0;var u,s=document.createElement("a");switch(e){case"script":u=function m(e){return s.href=e.src,s.pathname==t?!0:!1};break;case"link":u=function v(e){return s.href=e.href,s.pathname==t?!0:!1}}for(var l=document.getElementsByTagName(e),h=0;h<l.length;h++)if(u(l[h]))return a&&a(),!0;f[t]=[],a&&f[t].push(a);var d=document.createElement(e);switch(o&&(d.charset=o),n||(n="head"),d.addEventListener("load",function(){f[t].forEach(function(e){e()}),delete f[t]},!1),e){case"script":d.type="text/javascript",c!==!1&&(d.async=!0),d.src=t;break;case"link":d.type="text/css",d.rel="stylesheet",d.href=t}document.getElementsByTagName(n)[0].appendChild(d)}function a(e){return"html"==e.type?(document.body.innerHTML=e.html,Promise.resolve()):"img"!=e.type?new Promise(function(t,n){o(e.type,e.objUrl,void 0,void 0,function(){t()},e.async)}):void 0}function c(e){return new Promise(function(t,n){return"html"==e.type?(t(e),!0):(h.getBlobUrl(e.url,e.type).then(function(n){e.objUrl=n,t(e)}),void 0)})}function i(e){var t=[];e.forEach(function(e){var n=[];e.forEach(function(e){n.push(c(e))}),t.push(Promise.all(n))}),t.reduce(function(e,t){return e.then(function(){return t}).then(function(e){var t=[];return e.forEach(function(e){t.push(a(e))}),Promise.all(t)})},Promise.resolve())}function u(){return n("POST",d.checkUrl(l),t(),"json").then(function(e){var t=h.createRecordObj(e);if(t)return t.manifest=e.response,t.url=l,h.set(t),t.manifest;throw e})}var s=604800,l="manifest.php",h={};h.objStoreName="appFiles",h.checkDb=new Promise(function(e,t){var n=indexedDB.open("installer",6);n.addEventListener("error",function(e){t()}),n.addEventListener("upgradeneeded",function(e){var t=n.result;t.objectStoreNames.contains(h.objStoreName)&&t.deleteObjectStore(h.objStoreName),t.createObjectStore(h.objStoreName,{keyPath:"url"})}),n.addEventListener("success",function(t){h.db=n.result,e()})}),h.cache={},h.set=function(e){return this.checkDb.then(function(){return new Promise(function(t,n){var r=h.db.transaction(h.objStoreName,"readwrite").objectStore(h.objStoreName).put(e);r.addEventListener("success",function(){h.cache[e.url]=e,t()})})})},h.rmv=function(e){return this.checkDb.then(function(){return new Promise(function(t,n){var r=h.db.transaction(h.objStoreName,"readwrite").objectStore(h.objStoreName)["delete"](e);r.addEventListener("success",function(){delete h.cache[e],t()}),r.addEventListener("error",n)})})},h.get=function(e){return this.cache[e]?Promise.resolve(this.cache[e]):this.checkDb.then(function(){return new Promise(function(t,n){var r=h.db.transaction(h.objStoreName).objectStore(h.objStoreName).get(e);r.addEventListener("success",function(){r.result?(h.cache[e]=r.result,t(h.cache[e])):n()}),r.addEventListener("error",n)})})},h.ouCache={},h.checkCss_checkObjUrl=function(e,t,n){var r=/(.*\/)[^\/]*$/;t=r.exec(t)[1];var o=/\.\.\//g,a=(e.match(o)||[]).length;if(a>0)for(var c=/[^\/]+\/$/,i=0;a>i;i++)t=t.replace(c,"");var u=e.replace(o,""),s=t+u,l;return".css"==s.substr(s.length-4)&&(l="link"),new Promise(function(t,r){h.getObjUrl(s,l).then(function(t){n.push({subStr:e,repStr:t.objUrl})},function(){n.push({subStr:e,repStr:window.location.origin+s})}).then(function(){t()})})},h.checkCss=function(e,t){return new Promise(function(n,r){var o=new FileReader;o.addEventListener("loadend",function(){for(var r=o.result,a=[],c=/url\(([^\)]+)\)/g,i=void 0;null!==(i=c.exec(r));)a.push(i[1]);new Promise(function(e,n){if(a.length>0){var o=[],c=[];a.forEach(function(e){var n=h.checkCss_checkObjUrl(e,t,o);c.push(n)}),Promise.all(c).then(function(){o.forEach(function(e){r=r.replace("url("+e.subStr+")","url("+e.repStr+")")}),e()})}else e()}).then(function(){n(new Blob([r],{type:e.type}))})}),o.readAsText(e)})},h.ouCache_setAndReturn=function(e,t){return this.ouCache[e]={objUrl:URL.createObjectURL(t.blob),record:t},this.ouCache[e]},h.getObjUrl=function(e,t){if("link"==t){var n=e+"_tmpCopy";return this.ouCache[n]?Promise.resolve(this.ouCache[n]):h.get(e).then(function(t){return h.checkCss(t.blob,e)}).then(function(e){var t={blob:e,url:n};return h.set(t)}).then(function(){return h.get(n)}).then(function(e){return h.ouCache_setAndReturn(n,e)})}return this.ouCache[e]?Promise.resolve(this.ouCache[e]):h.get(e).then(function(t){return h.ouCache_setAndReturn(e,t)})},h.createRecordObj=function(e){if(200!==e.status)return!1;var t={dlDate:Date.now(),lastModified:e.getResponseHeader("Last-Modified")},n=/max\-age=([0-9]+)($|,)/;t.maxAge=n.exec(e.getResponseHeader("Cache-Control")),t.maxAge=null==t.maxAge?0:parseInt(t.maxAge[1]);var r=e.getResponseHeader("Etag");return r&&(t.eTag=r),t},h.checkExpire=function(e){return e.dlDate+1e3*e.maxAge<Date.now()?!0:!1},h.createHdrFrom=function(e){var t=[{hdr:"If-Modified-Since",value:e.lastModified}];return e.eTag&&t.push({hdr:"If-None-Match",value:e.eTag}),t},h.checkUpdate=function(e,t,r){return n("GET",t,void 0,r,this.createHdrFrom(e)).then(function(e){if(200==e.status)return e;throw e})},h.setBlob=function(e,t){var n=h.createRecordObj(t);return n?(n.blob=t.response,n.url=e,h.set(n)):void 0},h.dlAndSetBlob=function(e){return n("POST",e,t(),"blob").then(function(t){return h.setBlob(e,t)})},h.lastUpdateP=Promise.resolve(),h.getBlobUrl=function(e,t){return h.getObjUrl(e,t).then(function(t){var n=t.record;return h.checkExpire(n)&&h.checkUpdate(n,e,"blob").then(function(){h.lastUpdateP.then(function(){return h.dlAndSetBlob(e)})}),t.objUrl},function(){return h.dlAndSetBlob(e).then(function(){return h.getObjUrl(e,t)}).then(function(e){return e.objUrl})})};var d={};d.checkUrl=function(e){return"/debug/view_test.php"==window.location.pathname?"/"+e:e};var f={},m=["jss/installer.js","shared/imgs/favicon.ico","shared/csss/default.css"],v=localStorage.getItem("installDate");v||(v=(new Date).toUTCString(),localStorage.setItem("installDate",v),localStorage.setItem("installerLastCheckDate","0")),parseInt(localStorage.getItem("installerLastCheckDate"))+0*s<Date.now()&&(m.forEach(function(e){e=d.checkUrl(e);var t=localStorage.getItem(e+"_lastModified");t&&"null"!=t||(t=v);var r=[{hdr:"If-Modified-Since",value:t}],o=localStorage.getItem(e+"_eTag");o&&r.push({hdr:"If-None-Match",value:o}),n("GET",e,void 0,void 0,r).then(function(t){if(200==t.status){localStorage.setItem(e+"_lastModified",t.getResponseHeader("Last-Modified"));var n=t.getResponseHeader("Etag");n?localStorage.setItem(e+"_eTag",n):localStorage.removeItem(e+"_eTag")}})}),localStorage.setItem("installerLastCheckDate",Date.now())),h.get(l).then(function(e){if(h.checkExpire(e)){var t=[{hdr:"If-Modified-Since",value:e.lastModified}];e.eTag&&t.push({hdr:"If-None-Match",value:e.eTag}),n("GET",d.checkUrl(l),void 0,"json",t).then(function(e){200==e.status&&u()})}return e.manifest},function(){return u()}).then(function(e){i(e)})}();