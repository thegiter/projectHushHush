!function(){function e(){return new Promise(function(e,t){"interactive"==document.readyState||"complete"==document.readyState?e():document.addEventListener("DOMContentLoaded",e,!1)})}function t(e,t,n,r,o){return new Promise(function(a,s){var c=new XMLHttpRequest;c.open(e,t,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o&&o.forEach(function(e){c.setRequestHeader(e.hdr,e.value)}),r&&(c.responseType=r),c.addEventListener("readystatechange",function(){4==c.readyState&&a(c)},!1),c.send(n)})}function n(){return"refuri="+window.location.hostname}function r(e,t){for(var n in e)e.hasOwnProperty(n)&&t(e[n],n)}function o(e,t,n,o,a,s){var c=!1;if(r(l,function(e,n){n==t&&(a&&e.push(a),c=!0)}),c)return!0;var i,u=document.createElement("a");switch(e){case"script":i=function(e){return u.href=e.src,u.pathname==t?!0:!1};break;case"link":i=function(e){return u.href=e.href,u.pathname==t?!0:!1}}for(var d=document.getElementsByTagName(e),f=0;f<d.length;f++)if(i(d[f]))return a&&a(),!0;l[t]=[],a&&l[t].push(a);var h=document.createElement(e);switch(o&&(h.charset=o),n||(n="head"),h.addEventListener("load",function(){l[t].forEach(function(e){e()}),delete l[t]},!1),e){case"script":h.type="text/javascript",s!==!1&&(h.async=!0),h.src=t;break;case"link":h.type="text/css",h.rel="stylesheet",h.href=t}document.getElementsByTagName(n)[0].appendChild(h)}function a(e){return"html"==e.type?(document.body.innerHTML=e.html,Promise.resolve()):"img"!=e.type?new Promise(function(t,n){o(e.type,e.objUrl,void 0,void 0,function(){t()},e.async)}):void 0}function s(e){return new Promise(function(n,r){return"html"==e.type?(n(e),!0):(d.getObjUrl(e.url).then(function(r){var o=r.objUrl,a=r.record;e.objUrl=o,n(e),d.checkExpire(a)&&t("GET",e.url,void 0,"blob",d.createHdrFrom(a)).then(function(t){200==t.status&&d.dlAndSetBlob(e.url,e.type)})},function(){d.dlAndSetBlob(e.url,e.type).then(function(){d.getObjUrl(e.url).then(function(t){e.objUrl=t.objUrl,n(e)})})}),void 0)})}function c(e){var t=[];e.forEach(function(e){var n=[];e.forEach(function(e){var t=s(e);n.push(t)});var r=Promise.all(n);t.push(r)}),t.reduce(function(e,t){return e.then(function(){return t}).then(function(e){var t=[];return e.forEach(function(e){var n=a(e);t.push(n)}),Promise.all(t)})},Promise.resolve())}function i(){return t("POST",debug.checkUrl(m),n(),"json").then(function(e){var t=d.createRecordObj(e);return t&&(t.manifest=e.response,t.url=m,d.set(t)),t.manifest})}var u=604800,d={};d.objStoreName="appFiles",d.checkDb=new Promise(function(e,t){var n=indexedDB.open("installer",2);n.addEventListener("error",function(e){t()}),n.addEventListener("upgradeneeded",function(e){var t=n.result;t.objectStoreNames.contains(d.objStoreName)||t.createObjectStore(d.objStoreName,{keyPath:"url"})}),n.addEventListener("success",function(t){d.db=n.result,e()})}),d.set=function(e){return this.checkDb.then(function(){return new Promise(function(t,n){var r=d.db.transaction(d.objStoreName,"readwrite").objectStore(d.objStoreName).put(e);r.addEventListener("success",t)})})},d.rmv=function(e){return this.checkDb.then(function(){return new Promise(function(t,n){var r=d.db.transaction(d.objStoreName,"readwrite").objectStore(d.objStoreName)["delete"](e);r.addEventListener("success",t),r.addEventListener("error",n)})})},d.get=function(e){return this.checkDb.then(function(){return new Promise(function(t,n){var r=d.db.transaction(d.objStoreName).objectStore(d.objStoreName).get(e);r.addEventListener("success",function(){r.result?t(r.result):n()}),r.addEventListener("error",n)})})},d.getObjUrl=function(e){return this.get(e).then(function(e){return{objUrl:URL.createObjectURL(e.blob),record:e}})},d.createRecordObj=function(e){if(200!==e.status)return!1;var t={dlDate:Date.now(),lastModified:e.getResponseHeader("Last-Modified")},n=/max\-age=([0-9]+)($|,)/;t.maxAge=n.exec(e.getResponseHeader("Cache-Control")),t.maxAge=null==t.maxAge?0:parseInt(t.maxAge[1]);var r=e.getResponseHeader("Etag");return r&&(t.eTag=r),t},d.checkExpire=function(e){return e.dlDate+1e3*e.maxAge<Date.now()?!0:!1},d.createHdrFrom=function(e){var t=[{hdr:"If-Modified-Since",value:e.lastModified}];return e.eTag&&t.push({hdr:"If-None-Match",value:e.eTag}),t},d.checkCss_checkObjUrl=function(e,t,n){var r=/(.*\/)[^\/]*$/;t=r.exec(t)[1];var o=/\.\.\//g,a=(e.match(o)||[]).length;if(a>0)for(var s=/[^\/]+\/$/,c=0;a>c;c++)t=t.replace(s,"");e=e.replace(o,"");var i=t+e;return new Promise(function(t,r){d.getObjUrl(i).then(function(r){n.push({subStr:e,repStr:r}),t()},function(){t()})})},d.checkCss=function(e,t,n){return new Promise(function(r,o){if("link"==t){var a=new FileReader;a.addEventListener("loadend",function(){for(var t=a.result,o=[],s=/url\(([^\)]+)\)/g,c;null!==(c=s.exec(t));)o.push(c[1]);new Promise(function(e,r){if(o.length>0){var a=[],s=[];o.forEach(function(e){var t=d.checkCss_checkObjUrl(e,n,a);s.push(t)}),Promise.all(s).then(function(){a.forEach(function(e){t=t.replace("url("+e.subStr+")","url("+e.repStr+")")}),e()})}else e()}).then(function(){r(new Blob([t],{type:e.type}))})}),a.readAsText(e)}else r(e)})},d.dlAndSetBlob=function(e,r){return t("POST",e,n(),"blob").then(function(t){var n=d.createRecordObj(t);return n?d.checkCss(t.response,r,e).then(function(t){return n.blob=t,n.url=e,d.set(n)}):void 0})},debug={},debug.checkUrl=function(e){return"/debug/view.php"==window.location.pathname?"/"+e:e};var l={};e().then(function(){var e=document.body;e.removeChild(e.children[0])}),document.title="の弑す魂の PS";var f=["","jss/installer.js","shared/imgs/favicon.ico","shared/csss/defualt.css","shared/errs/csss/002.css","shared/errs/csss/cmn_dft.css","shared/csss/logo.css","shared/logo/stt/csss/stt.css","shared/csss/hr.css","shared/footer/sml/csss/footer.css","shared/footer/cr/csss/cr.css","shared/errs/imgs/002_ico.jpg","shared/errs/imgs/err_bnr.jpg","shared/imgs/logo_lgt.png","shared/imgs/logo.png","shared/imgs/hr_head.png","shared/imgs/hr_body.png","shared/imgs/hr_ass.png","shared/imgs/site_icon_16.png"],h=localStorage.getItem("installDate");h||(h=(new Date).toUTCString(),localStorage.setItem("installDate",h),localStorage.setItem("installerLastCheckDate","0")),parseInt(localStorage.getItem("installerLastCheckDate"))+1e3*u<Date.now()&&(f.forEach(function(e){e=debug.checkUrl(e);var n=localStorage.getItem(e+"_lastModified");n||(n=h);var r=[{hdr:"If-Modified-Since",value:n}],o=localStorage.getItem(e+"_eTag");o&&r.push({hdr:"If-None-Match",value:o}),t("GET",e,void 0,void 0,r).then(function(t){if(200==t.status){localStorage.setItem(e+"_lastModified",t.getResponseHeader("Last-Modified"));var n=t.getResponseHeader("Etag");n?localStorage.setItem(e+"_eTag",n):localStorage.removeItem(e+"_eTag")}})}),localStorage.setItem("installerLastCheckDate",Date.now())),document.head.querySelector('meta[name="robots"]').content="index,follow";var m="manifest.php";d.get(m).then(function(e){if(c(e.manifest),d.checkExpire(e)){var n=[{hdr:"If-Modified-Since",value:e.lastModified}];e.eTag&&n.push({hdr:"If-None-Match",value:e.eTag}),t("GET",debug.checkUrl(m),void 0,"json",n).then(function(e){200==e.status&&(console.log("ajax response:"+e.reponse),i())})}},function(){i()["catch"](function(){}).then(function(e){c(e)})})}();